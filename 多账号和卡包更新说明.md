# 多账号登录和卡包持久化更新说明

## ✅ 已解决的问题

### 1. 多标签页独立登录问题

**问题描述：**
- 在同一浏览器打开多个标签页登录不同账号时，由于 localStorage 是全局共享的，导致登录状态相互覆盖

**解决方案：**
- 将 `localStorage` 改为 `sessionStorage`
- sessionStorage 的数据只在当前标签页有效，关闭标签页就清除
- 每个标签页都有独立的 session，互不干扰

**具体改动：**
- 文件：[src/utils/api.js](c:\Users\40902\Desktop\word_stone\word_stone\src\utils\api.js)
- 所有 `localStorage` 改为 `sessionStorage`

**现在的行为：**
- ✅ 可以在不同标签页登录不同账号
- ✅ 每个标签页的登录状态独立
- ✅ 关闭标签页后自动退出登录
- ⚠️ 刷新页面仍然保持登录（在同一标签页内）

### 2. 卡包数据持久化

**问题描述：**
- 卡包数量只存在内存中，刷新页面后丢失

**解决方案：**
- 创建卡包管理 API 接口
- 将卡包数量保存到数据库
- 登录时自动加载卡包数据
- 领取/使用卡包时实时同步数据库

**新增功能：**

#### 后端 API 接口
文件：[src/routes/packs.js](c:\Users\40902\Desktop\word_stone\word_stone_server\src\routes\packs.js)

- `GET /api/packs` - 获取所有可用卡包
- `GET /api/packs/me` - 获取当前用户的卡包库存
- `POST /api/packs/me/add` - 给用户添加卡包
- `POST /api/packs/me/:packId/use` - 使用卡包（减少数量）

#### 前端改动
文件：[src/hooks/useGame.js](c:\Users\40902\Desktop\word_stone\word_stone\src\hooks\useGame.js)

- 登录时自动从数据库加载卡包数量
- `addPacks()` - 领取卡包时同步到数据库
- `openPack()` - 使用卡包时同步到数据库

#### 数据库初始化
文件：[src/scripts/seed.js](c:\Users\40902\Desktop\word_stone\word_stone_server\src\scripts\seed.js)

- 创建默认卡包："基础卡包"
- ID: `default-pack-001`
- 包含 5 张卡，稀有度权重：common(70%), rare(20%), epic(8%), legendary(2%)

## 📊 数据流程

### 领取卡包
```
1. 用户点击"领取卡包"按钮
2. 前端更新显示（+5 卡包）
3. 发送 API 请求到后端
4. 后端更新数据库（user_packs 表）
5. 后端更新用户总卡包数（users.totalPacks）
6. 完成
```

### 使用卡包
```
1. 用户点击"开启卡包"按钮
2. 前端更新显示（-1 卡包）
3. 发送 API 请求到后端
4. 后端减少卡包数量
5. 后端更新用户总卡包数
6. 前端显示抽到的卡片
```

### 刷新页面
```
1. 检查 sessionStorage 中的 token
2. 验证 token 有效性
3. 自动登录
4. 从数据库加载卡包数量
5. 从数据库加载鲜花数
6. 连接 WebSocket
7. 恢复完整状态
```

## 🗄️ 数据库表结构

### users 表（用户表）
```sql
- id (主键)
- username
- totalRoses (总鲜花数) ← 已持久化
- totalPacks (总卡包数) ← 新增持久化
- ...
```

### packs 表（卡包类型表）
```sql
- id (主键)
- name (卡包名称)
- description (描述)
- cardCount (每包卡片数)
- weights (稀有度权重，JSON)
- isActive (是否启用)
```

### user_packs 表（用户卡包库存表）
```sql
- userId (用户ID，外键)
- packId (卡包ID，外键)
- count (数量)
- PRIMARY KEY (userId, packId)
```

## 🔄 sessionStorage vs localStorage 对比

| 特性 | localStorage | sessionStorage |
|-----|-------------|----------------|
| **存储范围** | 整个浏览器（所有标签页共享） | 当前标签页独立 |
| **生命周期** | 永久（除非手动清除） | 关闭标签页后清除 |
| **刷新页面** | 保留 | 保留（同一标签页内） |
| **多账号** | ❌ 会互相覆盖 | ✅ 可以独立登录 |
| **安全性** | 相同 | 相同 |

## 💡 使用场景

### 适合 sessionStorage 的场景（当前使用）
✅ **多账号测试** - 开发者在不同标签页测试多个账号
✅ **临时会话** - 关闭标签页就自动退出
✅ **安全考虑** - 减少 token 泄露风险

### 适合 localStorage 的场景
✅ **长期登录** - 用户希望关闭浏览器后仍保持登录
✅ **单账号使用** - 用户只会在一个标签页使用

## 🎯 使用指南

### 多账号测试
1. **第一个标签页**：
   ```
   打开 http://localhost:5173
   登录账号 A
   ```

2. **第二个标签页**：
   ```
   新开标签页 → http://localhost:5173
   登录账号 B
   ```

3. **测试结果**：
   - ✅ 两个标签页显示不同的用户信息
   - ✅ 两个账号互不干扰
   - ✅ 刷新各自的页面都能保持登录

### 卡包功能测试

1. **领取卡包**：
   ```javascript
   点击"领取卡包" → 立即获得 5 个卡包
   刷新页面 → 卡包数量保持
   ```

2. **使用卡包**：
   ```javascript
   点击"开启卡包" → 消耗 1 个卡包
   获得 5 张随机卡片
   刷新页面 → 卡包数量正确
   ```

3. **查看数据库**：
   ```bash
   cd word_stone_server
   pnpm prisma studio
   # 浏览器打开 http://localhost:5555
   # 查看 users 表的 totalPacks 字段
   # 查看 user_packs 表的库存记录
   ```

## 🐛 调试技巧

### 查看当前登录状态
```javascript
// 浏览器控制台
console.log('Token:', sessionStorage.getItem('token'));
console.log('User:', JSON.parse(sessionStorage.getItem('user')));
```

### 手动清除登录状态
```javascript
// 浏览器控制台
sessionStorage.clear();
location.reload();
```

### 查看卡包数据
```bash
# 后端目录
cd word_stone_server
pnpm prisma studio

# 或使用 SQL
psql -U postgres -d vocab_game
SELECT username, totalPacks FROM users;
SELECT * FROM user_packs;
```

## 🔧 后续优化建议

### 1. 灵活的存储策略
可以让用户选择：
```javascript
// 在登录页添加"记住我"选项
const storage = rememberMe ? localStorage : sessionStorage;
storage.setItem('token', token);
```

### 2. 卡包类型管理
- 添加多种卡包类型（初级、高级、传说等）
- 不同卡包有不同的稀有度权重
- 用户可以选择使用哪种卡包

### 3. 卡包历史记录
```sql
CREATE TABLE pack_history (
  id UUID PRIMARY KEY,
  userId UUID,
  packId UUID,
  openedAt TIMESTAMP,
  cards JSON -- 抽到的卡片记录
);
```

### 4. 批量操作
```javascript
// 一次开启 10 个卡包
POST /api/packs/me/:packId/open-multiple
{ count: 10 }
```

## 📈 性能考虑

### 数据库查询优化
- ✅ 使用索引加速查询
- ✅ 减少不必要的数据库调用
- ✅ 使用 Prisma 的批量操作

### 前端缓存策略
- ✅ sessionStorage 减少网络请求
- ✅ 只在必要时同步数据库
- ⚠️ 注意处理网络错误（重试机制）

## 🔐 安全注意事项

### Token 存储
- sessionStorage 相对安全（标签页关闭即清除）
- 仍然需要防范 XSS 攻击
- 生产环境建议使用 httpOnly Cookie

### API 安全
- ✅ 所有卡包操作都需要 JWT 认证
- ✅ 服务器验证用户权限
- ✅ 防止恶意刷卡包

## 📋 测试清单

- [x] 多标签页可以登录不同账号
- [x] 刷新页面保持登录状态（同一标签页）
- [x] 关闭标签页自动退出登录
- [x] 领取卡包同步到数据库
- [x] 使用卡包同步到数据库
- [x] 刷新页面后卡包数量正确
- [x] 鲜花数量刷新后保持
- [x] 默认卡包已创建
- [x] 数据库连接正常
- [x] API 接口返回正确

## 🚀 运行说明

### 启动后端
```bash
cd word_stone_server
node index.js
# 服务器运行在 http://localhost:3000
```

### 启动前端
```bash
cd word_stone
npm run dev
# 前端运行在 http://localhost:5173
```

### 初始化数据库（如果需要）
```bash
cd word_stone_server
node src/scripts/seed.js
```

现在可以愉快地在多个标签页测试不同账号了！🎉
