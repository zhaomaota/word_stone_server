# 功能更新说明

## ✅ 已实现功能

### 1. 自动登录（刷新页面保持登录状态）

**工作原理：**
- 用户登录后，Token 和用户信息保存在浏览器的 localStorage
- 每次刷新页面时，自动检查 localStorage 中的 Token
- 如果 Token 有效，自动登录并恢复用户状态

**实现细节：**
- [App.jsx](c:\Users\40902\Desktop\word_stone\word_stone\src\App.jsx) 中添加了 `useEffect` 检查登录状态
- 启动时显示"加载中..."，验证完成后才显示主界面
- Token 验证失败会自动清除登录信息

**用户体验：**
- ✅ 刷新页面后无需重新输入账号密码
- ✅ 自动恢复用户名和鲜花数
- ✅ Token 过期会自动退出到登录页

### 2. 鲜花数持久化（保存到数据库）

**工作原理：**
- 用户连接时从数据库加载鲜花总数
- 每次送花/取消送花时实时更新数据库
- 刷新页面后鲜花数自动恢复

**实现细节：**
- WebSocket 的 `join` 事件改为异步函数，查询数据库获取用户鲜花数
- `send-rose` 事件在修改内存数据后立即更新数据库
- 即使数据库操作失败，游戏也能正常运行（使用内存数据）

**数据流程：**
```
1. 用户登录 → 查询数据库 → 加载鲜花数
2. 收到鲜花 → 更新内存 → 更新数据库 → 广播给所有用户
3. 刷新页面 → 重新查询数据库 → 恢复鲜花数
```

## 📋 数据存储位置

### LocalStorage（浏览器本地存储）
存储内容：
- `token` - JWT 认证令牌
- `user` - 用户基本信息（userId, username, role）

查看方式：
1. 打开浏览器开发者工具（F12）
2. 进入 Application 标签
3. 左侧找到 Local Storage
4. 选择你的网站地址

### PostgreSQL 数据库
存储内容：
- 用户完整信息（包括 totalRoses）
- 单词、卡包、图鉴等游戏数据

查看方式：
```bash
# 使用 Prisma Studio
cd c:\Users\40902\Desktop\word_stone\word_stone_server
pnpm prisma studio

# 或直接连接数据库
psql -U postgres -d vocab_game
SELECT username, totalRoses FROM users;
```

## 🔄 数据同步机制

### 登录流程
```
1. 输入账号密码
2. 发送到后端验证
3. 后端返回 Token + 用户信息
4. 前端保存到 localStorage
5. 连接 WebSocket
6. 从数据库加载鲜花数
```

### 刷新页面流程
```
1. 检查 localStorage 是否有 Token
2. 如果有 → 验证 Token 是否有效
3. Token 有效 → 自动登录
4. 连接 WebSocket → 加载最新鲜花数
5. Token 无效 → 清除数据 → 显示登录页
```

### 送花流程
```
1. 用户点击送花按钮
2. 发送 WebSocket 事件
3. 服务器验证并更新内存数据
4. 服务器更新数据库（异步）
5. 广播给所有在线用户
6. 接收者的鲜花数实时更新
```

## 🐛 错误处理

### Token 相关
- Token 不存在：显示登录页
- Token 过期：自动清除，显示登录页
- Token 无效：清除数据，显示登录页
- 验证失败：打印错误，显示登录页

### 数据库相关
- 连接失败：使用默认值（0 朵鲜花）
- 查询失败：不影响用户连接
- 更新失败：打印错误，但不影响游戏

### WebSocket 相关
- 连接断开：显示离线状态
- 重新连接：自动恢复状态
- 消息丢失：无影响（消息不持久化）

## 💡 使用建议

### 用户端
1. **首次使用**：注册账号
2. **日常使用**：直接打开网页（自动登录）
3. **更换浏览器**：需要重新登录
4. **清除缓存后**：需要重新登录

### 开发调试
1. **清除登录状态**：
   ```javascript
   // 浏览器控制台执行
   localStorage.clear();
   location.reload();
   ```

2. **查看当前 Token**：
   ```javascript
   console.log(localStorage.getItem('token'));
   ```

3. **查看用户信息**：
   ```javascript
   console.log(JSON.parse(localStorage.getItem('user')));
   ```

4. **查看数据库中的鲜花数**：
   ```bash
   pnpm prisma studio
   # 然后在浏览器中打开 users 表
   ```

## 🔐 安全提示

1. **Token 存储**：
   - ✅ 使用 localStorage（方便但有 XSS 风险）
   - 生产环境建议使用 httpOnly Cookie

2. **Token 有效期**：
   - 当前：7 天
   - 可在后端修改（auth.js 中的 expiresIn）

3. **密码安全**：
   - 密码使用 bcrypt 加密存储
   - 前端传输时使用 HTTPS（生产环境）

## 📊 性能优化

1. **内存使用**：
   - WebSocket 用户数据存在内存
   - 消息只保留最近 100 条
   - 24 小时后自动清理旧消息

2. **数据库查询**：
   - 只在用户连接时查询一次
   - 送花时只更新一个字段
   - 使用索引优化查询速度

3. **前端缓存**：
   - Token 保存在 localStorage
   - 用户信息缓存在 localStorage
   - 减少重复请求

## 🚀 后续优化建议

1. **Token 刷新机制**：
   - 实现 Refresh Token
   - Token 快过期时自动刷新

2. **离线消息**：
   - 将重要消息保存到数据库
   - 用户上线时加载离线消息

3. **鲜花历史**：
   - 记录每次送花的详细信息
   - 显示送花历史和统计

4. **性能监控**：
   - 记录登录失败次数
   - 监控数据库查询时间
   - 统计用户在线时长
